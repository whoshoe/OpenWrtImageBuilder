name: Check Passwall Update

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at 00:00 UTC
  workflow_dispatch: # Allows manual triggering for testing

jobs:
  check_and_tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTIONS_PAT }} # IMPORTANT: Use PAT to ensure the push triggers the next workflow
          fetch-depth: 0 # Fetch all history so we can check existing tags

      - name: Check Latest Passwall Version
        id: check
        run: |
          # 1. Fetch the latest release tag from upstream (Openwrt-Passwall)
          UPSTREAM_URL="https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall/releases/latest"
          
          # Fetch JSON and extract tag_name. 
          # We use -L to follow redirects and -s for silent mode.
          LATEST_TAG=$(curl -s -L "$UPSTREAM_URL" | jq -r '.tag_name')
          
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            echo "::error::Failed to fetch latest Passwall version."
            exit 1
          fi

          echo "Latest Upstream Version: $LATEST_TAG"

          # 2. Format the local tag. 
          # We prefix it with 'passwall-' to keep it distinct from other potential tags.
          LOCAL_TAG_NAME="passwall-${LATEST_TAG}"

          # 3. Check if this tag already exists in our repo
          if git rev-parse "$LOCAL_TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $LOCAL_TAG_NAME already exists. No update needed."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "Tag $LOCAL_TAG_NAME does not exist. Triggering update."
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "new_tag=$LOCAL_TAG_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Push New Tag
        if: steps.check.outputs.update_needed == 'true'
        env:
          NEW_TAG: ${{ steps.check.outputs.new_tag }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          echo "Creating tag $NEW_TAG..."
          git tag "$NEW_TAG"
          
          echo "Pushing tag..."
          # Because we checked out with the PAT, this push will trigger other workflows
          git push origin "$NEW_TAG"
